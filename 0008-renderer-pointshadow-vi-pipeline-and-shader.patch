From 957b9fca62544ccd827f45f177835e40e551518f Mon Sep 17 00:00:00 2001
From: oai <oai@example.com>
Date: Tue, 17 Feb 2026 16:47:10 +0000
Subject: [PATCH] renderer: add point shadow VI pipeline and SM6 shader

---
 assets/shaders/ShadowPointVI_dx12.hlsl        | 57 +++++++++++++++++++
 src/Render/DirectX12/DirectX12Renderer.cppm   |  1 +
 ...rer_CreateResources_02_ShadowPipelines.inl | 27 +++++++++
 3 files changed, 85 insertions(+)
 create mode 100644 assets/shaders/ShadowPointVI_dx12.hlsl

diff --git a/assets/shaders/ShadowPointVI_dx12.hlsl b/assets/shaders/ShadowPointVI_dx12.hlsl
new file mode 100644
index 0000000..9cadbdf
--- /dev/null
+++ b/assets/shaders/ShadowPointVI_dx12.hlsl
@@ -0,0 +1,57 @@
+// ShadowPointVI_dx12.hlsl
+// Shader Model 6.1 (DXC) vertex+pixel shader for point light shadow cubemap.
+// Uses SV_ViewID + View-Instancing to render all 6 faces in a single pass.
+
+cbuffer PointShadowCB : register(b0)
+{
+    float4x4 uFaceViewProj[6];
+    float4   uLightPosRange; // xyz + range
+    float4   uMisc;          // x = bias (reserved)
+};
+
+struct VSIn
+{
+    float3 pos : POSITION;
+    float3 nrm : NORMAL;
+    float2 uv  : TEXCOORD0;
+
+    float4 i0  : TEXCOORD1;
+    float4 i1  : TEXCOORD2;
+    float4 i2  : TEXCOORD3;
+    float4 i3  : TEXCOORD4;
+
+    uint   viewId : SV_ViewID;
+};
+
+float4x4 MakeMatRows(float4 r0, float4 r1, float4 r2, float4 r3)
+{
+    return float4x4(r0, r1, r2, r3);
+}
+
+struct VSOut
+{
+    float4 posH     : SV_Position;
+    float3 worldPos : TEXCOORD0;
+};
+
+VSOut VS_ShadowPointVI(VSIn IN)
+{
+    VSOut OUT;
+
+    float4x4 model = MakeMatRows(IN.i0, IN.i1, IN.i2, IN.i3);
+    float4 world = mul(float4(IN.pos, 1.0f), model);
+
+    OUT.worldPos = world.xyz;
+    const uint face = (IN.viewId < 6u) ? IN.viewId : 0u;
+    OUT.posH = mul(world, uFaceViewProj[face]);
+    return OUT;
+}
+
+// R32_FLOAT distance (normalized by range).
+float PS_ShadowPointVI(VSOut IN) : SV_Target0
+{
+    float3 L = IN.worldPos - uLightPosRange.xyz;
+    float dist = length(L);
+    float norm = saturate(dist / max(uLightPosRange.w, 0.001f));
+    return norm;
+}
diff --git a/src/Render/DirectX12/DirectX12Renderer.cppm b/src/Render/DirectX12/DirectX12Renderer.cppm
index 7e8da46..2542674 100644
--- a/src/Render/DirectX12/DirectX12Renderer.cppm
+++ b/src/Render/DirectX12/DirectX12Renderer.cppm
@@ -399,6 +399,7 @@ export namespace rendern
 
 		// Point shadow pass (R32_FLOAT distance cubemap)
 		rhi::PipelineHandle psoPointShadow_{};
+		rhi::PipelineHandle psoPointShadowVI_{}; // SM6.1 + SV_ViewID + view instancing (single-pass cubemap)
 		rhi::GraphicsState pointShadowState_{};
 
 		MeshRHI skyboxMesh_{};
diff --git a/src/Render/DirectX12/RendererImpl/DirectX12Renderer_CreateResources_02_ShadowPipelines.inl b/src/Render/DirectX12/RendererImpl/DirectX12Renderer_CreateResources_02_ShadowPipelines.inl
index d4f5cb0..079c4b4 100644
--- a/src/Render/DirectX12/RendererImpl/DirectX12Renderer_CreateResources_02_ShadowPipelines.inl
+++ b/src/Render/DirectX12/RendererImpl/DirectX12Renderer_CreateResources_02_ShadowPipelines.inl
@@ -30,6 +30,8 @@
 			// Point shadow pipeline (R32_FLOAT distance cubemap)
 			if (device_.GetBackend() == rhi::Backend::DirectX12)
 			{
+				const std::filesystem::path pointShadowVIPath = corefs::ResolveAsset("shaders\\ShadowPointVI_dx12.hlsl");
+
 				const auto vsPoint = shaderLibrary_.GetOrCreateShader(ShaderKey{
 					.stage = rhi::ShaderStage::Vertex,
 					.name = "VS_ShadowPoint",
@@ -44,6 +46,31 @@
 					});
 				psoPointShadow_ = psoCache_.GetOrCreate("PSO_PointShadow", vsPoint, psPoint);
 
+				// Optional View-Instancing variant (single pass renders all 6 cubemap faces).
+				// Requires SM6.1 + DXC + ViewInstancingTier support.
+				if (device_.SupportsShaderModel6() && device_.SupportsViewInstancing())
+				{
+					const auto vsPointVI = shaderLibrary_.GetOrCreateShader(ShaderKey{
+						.stage = rhi::ShaderStage::Vertex,
+						.shaderModel = rhi::ShaderModel::SM6_1,
+						.name = "VS_ShadowPointVI",
+						.filePath = pointShadowVIPath.string(),
+						.defines = {}
+						});
+					const auto psPointVI = shaderLibrary_.GetOrCreateShader(ShaderKey{
+						.stage = rhi::ShaderStage::Pixel,
+						.shaderModel = rhi::ShaderModel::SM6_1,
+						.name = "PS_ShadowPointVI",
+						.filePath = pointShadowVIPath.string(),
+						.defines = {}
+						});
+
+					if (vsPointVI && psPointVI)
+					{
+						psoPointShadowVI_ = psoCache_.GetOrCreate("PSO_PointShadow_VI", vsPointVI, psPointVI, rhi::PrimitiveTopologyType::Triangle, 6);
+					}
+				}
+
 				pointShadowState_.depth.testEnable = true;
 				pointShadowState_.depth.writeEnable = true;
 				pointShadowState_.depth.depthCompareOp = rhi::CompareOp::LessEqual;
-- 
2.39.5

